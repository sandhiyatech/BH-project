name: Setup Additional Self-Hosted Runner

on:
  push:
    branches:
      - main

jobs:
  setup-additional-runner:
    runs-on: self-hosted
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Install SSH client
      run: sudo apt-get update && sudo apt-get install -y sshpass

    - name: SSH into Azure VM and setup additional runner
      env:
        AZURE_VM_PASSWORD: ${{ secrets.AZURE_VM_PASSWORD }}
      run: |
        sshpass -p "$AZURE_VM_PASSWORD" ssh -o StrictHostKeyChecking=no ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_IP }} << EOF
          mkdir -p actions-runner-new && cd actions-runner-new
          curl -o actions-runner-linux-x64-2.284.0.tar.gz -L https://github.com/actions/runner/releases/download/v2.284.0/actions-runner-linux-x64-2.284.0.tar.gz
          tar xzf ./actions-runner-linux-x64-2.284.0.tar.gz
          ./config.sh --url ${{ secrets.REPOSITORY_URL }} --token ${{ secrets.RUNNER_TOKEN }}
          sudo ./svc.sh install
          sudo ./svc.sh start
        EOF

    - name: Wait for runner to register
      run: sleep 60
